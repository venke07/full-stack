<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Neural AI Dashboard ‚Äì Agent Control Center</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-glow: #00d4ff;
      --secondary-glow: #7c3aed;
      --accent-glow: #f59e0b;
      --success-glow: #10b981;
      --neural-dark: #0a0a0f;
      --neural-surface: #1a1a2e;
      --neural-border: #16213e;
      --text-primary: #ffffff;
      --text-secondary: #94a3b8;
      --card-surface: rgba(26, 26, 46, 0.6);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--neural-dark);
      min-height: 100vh;
      color: var(--text-primary);
      overflow-x: hidden;
    }

    /* Neural Background */
    .neural-background {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      background: radial-gradient(ellipse at center, rgba(0, 212, 255, 0.08) 0%, transparent 70%),
                  radial-gradient(ellipse at 80% 20%, rgba(124, 58, 237, 0.12) 0%, transparent 50%);
    }

    .neural-grid {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: 
        linear-gradient(rgba(0, 212, 255, 0.05) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 212, 255, 0.05) 1px, transparent 1px);
      background-size: 40px 40px;
      animation: gridPulse 8s ease-in-out infinite;
    }

    /* Header */
    .header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: rgba(26, 26, 46, 0.95);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--neural-border);
      padding: 20px 40px;
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo-section {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .header-logo {
      width: 40px;
      height: 40px;
      background: var(--primary-glow);
      border-radius: 50%;
      box-shadow: 0 0 20px var(--primary-glow);
      animation: corePulse 3s ease-in-out infinite;
    }

    .header-title {
      font-size: 24px;
      font-weight: 700;
      background: linear-gradient(135deg, var(--primary-glow), var(--secondary-glow));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .header-controls {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 16px;
      background: var(--card-surface);
      border-radius: 20px;
      border: 1px solid var(--neural-border);
    }

    .user-avatar {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, var(--primary-glow), var(--secondary-glow));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 14px;
      color: var(--neural-dark);
    }

    .user-name {
      font-size: 14px;
      font-weight: 500;
    }

    .logout-btn {
      padding: 10px 20px;
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 12px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
      font-family: 'Inter', sans-serif;
    }

    .logout-btn:hover {
      background: rgba(239, 68, 68, 0.3);
      border-color: #ef4444;
      transform: translateY(-1px);
    }

    /* Main Dashboard */
    .dashboard-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 40px;
    }

    /* Status Bar */
    .status-bar {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }

    .status-card {
      background: var(--card-surface);
      border: 1px solid var(--neural-border);
      border-radius: 16px;
      padding: 24px;
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .status-card:hover {
      border-color: var(--primary-glow);
      transform: translateY(-2px);
      box-shadow: 0 10px 40px rgba(0, 212, 255, 0.1);
    }

    .status-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, var(--primary-glow), var(--secondary-glow), var(--accent-glow));
    }

    .status-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .status-title {
      font-size: 14px;
      color: var(--text-secondary);
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .status-icon {
      font-size: 20px;
    }

    .status-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .status-change {
      font-size: 12px;
      font-family: 'JetBrains Mono', monospace;
    }

    .positive { color: var(--success-glow); }
    .neutral { color: var(--text-secondary); }

    /* Agent Control Grid */
    .control-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 30px;
      margin-bottom: 40px;
    }

    .main-panel {
      background: var(--card-surface);
      border: 1px solid var(--neural-border);
      border-radius: 20px;
      padding: 30px;
      position: relative;
    }

    .main-panel::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--primary-glow), transparent);
      animation: borderScan 4s linear infinite;
    }

    .panel-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .neural-interface {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-bottom: 30px;
    }

    .neural-node {
      aspect-ratio: 1;
      background: rgba(22, 33, 62, 0.5);
      border: 2px solid var(--neural-border);
      border-radius: 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .neural-node:hover {
      border-color: var(--primary-glow);
      background: rgba(0, 212, 255, 0.1);
      transform: scale(1.05);
    }

    .neural-node.active {
      border-color: var(--success-glow);
      background: rgba(16, 185, 129, 0.1);
      box-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
    }

    .node-icon {
      font-size: 24px;
      margin-bottom: 8px;
    }

    .node-label {
      font-size: 12px;
      font-weight: 500;
      text-align: center;
      color: var(--text-secondary);
    }

    .node-status {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--neural-border);
    }

    .node-status.online {
      background: var(--success-glow);
      box-shadow: 0 0 10px var(--success-glow);
      animation: statusPulse 2s ease-in-out infinite;
    }

    /* Side Panel */
    .side-panel {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .activity-feed {
      background: var(--card-surface);
      border: 1px solid var(--neural-border);
      border-radius: 16px;
      padding: 24px;
      flex: 1;
    }

    .activity-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 0;
      border-bottom: 1px solid var(--neural-border);
    }

    .activity-item:last-child {
      border-bottom: none;
    }

    .activity-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--primary-glow);
      box-shadow: 0 0 8px var(--primary-glow);
    }

    .activity-text {
      font-size: 13px;
      color: var(--text-secondary);
      flex: 1;
    }

    .activity-time {
      font-size: 11px;
      color: var(--text-secondary);
      font-family: 'JetBrains Mono', monospace;
    }

    /* Animations */
    @keyframes gridPulse {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 0.1; }
    }

    @keyframes corePulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.1); opacity: 0.9; }
    }

    @keyframes borderScan {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    @keyframes statusPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    /* Responsive Design */
    @media (max-width: 1200px) {
      .control-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .dashboard-container {
        padding: 20px;
      }

      .header {
        padding: 16px 20px;
      }

      .header-content {
        flex-direction: column;
        gap: 16px;
        align-items: flex-start;
      }

      .status-bar {
        grid-template-columns: 1fr;
      }

      .neural-interface {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>
<body>
  <div class="neural-background">
    <div class="neural-grid"></div>
  </div>

  <div class="header">
    <div class="header-content">
      <div class="logo-section">
        <div class="header-logo"></div>
        <div class="header-title">Neural Control Center</div>
      </div>
      
      <div class="header-controls">
        <div class="user-info">
          <div class="user-avatar" id="userAvatar">A</div>
          <span class="user-name" id="userName">Agent</span>
        </div>
        <button class="logout-btn" onclick="logout()">
          <span>üöÄ</span> Disconnect
        </button>
      </div>
    </div>
  </div>

  <div class="dashboard-container">
    <!-- Status Bar -->
    <div class="status-bar">
      <div class="status-card">
        <div class="status-header">
          <span class="status-title">Neural Core</span>
          <span class="status-icon">üß†</span>
        </div>
        <div class="status-value">98.7%</div>
        <div class="status-change positive">+2.3% optimal</div>
      </div>

      <div class="status-card">
        <div class="status-header">
          <span class="status-title">Active Agents</span>
          <span class="status-icon">‚ö°</span>
        </div>
        <div class="status-value">24</div>
        <div class="status-change positive">+6 this session</div>
      </div>

      <div class="status-card">
        <div class="status-header">
          <span class="status-title">Processing Load</span>
          <span class="status-icon">üìä</span>
        </div>
        <div class="status-value">67%</div>
        <div class="status-change neutral">stable</div>
      </div>

      <div class="status-card">
        <div class="status-header">
          <span class="status-title">Quantum Sync</span>
          <span class="status-icon">üîê</span>
        </div>
        <div class="status-value">SECURE</div>
        <div class="status-change positive">all channels</div>
      </div>
    </div>

    <!-- Main Control Grid -->
    <div class="control-grid">
      <div class="main-panel">
        <h2 class="panel-title">
          <span>üéØ</span>
          Agent Management Interface
        </h2>
        
        <div class="neural-interface">
          <div class="neural-node active" onclick="toggleNode(this, 'Language Processing')">
            <div class="node-status online"></div>
            <div class="node-icon">üí≠</div>
            <div class="node-label">Language<br>Processing</div>
          </div>
          
          <div class="neural-node" onclick="toggleNode(this, 'Vision System')">
            <div class="node-status"></div>
            <div class="node-icon">üëÅÔ∏è</div>
            <div class="node-label">Vision<br>System</div>
          </div>
          
          <div class="neural-node active" onclick="toggleNode(this, 'Decision Engine')">
            <div class="node-status online"></div>
            <div class="node-icon">üéØ</div>
            <div class="node-label">Decision<br>Engine</div>
          </div>
          
          <div class="neural-node" onclick="toggleNode(this, 'Memory Banks')">
            <div class="node-status"></div>
            <div class="node-icon">üßÆ</div>
            <div class="node-label">Memory<br>Banks</div>
          </div>
          
          <div class="neural-node active" onclick="toggleNode(this, 'Learning Core')">
            <div class="node-status online"></div>
            <div class="node-icon">üìö</div>
            <div class="node-label">Learning<br>Core</div>
          </div>
          
          <div class="neural-node" onclick="toggleNode(this, 'Communication Hub')">
            <div class="node-status"></div>
            <div class="node-icon">üì°</div>
            <div class="node-label">Communication<br>Hub</div>
          </div>
        </div>

        <div style="text-align: center; color: var(--text-secondary); font-size: 14px; margin-top: 20px;">
          Click neural nodes to activate/deactivate agent capabilities
        </div>
      </div>

      <div class="side-panel">
        <div class="activity-feed">
          <h3 class="panel-title" style="font-size: 16px;">
            <span>üìà</span>
            System Activity
          </h3>
          
          <div class="activity-item">
            <div class="activity-dot"></div>
            <div class="activity-text">Neural core initialized</div>
            <div class="activity-time">2m ago</div>
          </div>
          
          <div class="activity-item">
            <div class="activity-dot"></div>
            <div class="activity-text">Agent protocols updated</div>
            <div class="activity-time">5m ago</div>
          </div>
          
          <div class="activity-item">
            <div class="activity-dot"></div>
            <div class="activity-text">Quantum sync established</div>
            <div class="activity-time">8m ago</div>
          </div>
          
          <div class="activity-item">
            <div class="activity-dot"></div>
            <div class="activity-text">Security protocols active</div>
            <div class="activity-time">12m ago</div>
          </div>
          
          <div class="activity-item">
            <div class="activity-dot"></div>
            <div class="activity-text">User session started</div>
            <div class="activity-time">15m ago</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    // Import Supabase configuration
    import { neuralManager } from './supabase-config.js';

    let currentUser = null;
    let userNodes = [];

    // Initialize dashboard
    async function initializeDashboard() {
      try {
        // Check if user is logged in
        const sessionData = sessionStorage.getItem('neuralSession');
        if (!sessionData) {
          throw new Error('No neural session found');
        }

        const session = JSON.parse(sessionData);
        currentUser = session.user;

        // Verify session is still valid
        const { session: currentSession } = await neuralManager.getCurrentSession();
        if (!currentSession) {
          throw new Error('Neural session expired');
        }

        // Initialize user interface
        const userName = document.getElementById("userName");
        const userAvatar = document.getElementById("userAvatar");
        
        const displayName = currentUser.user_metadata?.display_name || 'Agent';
        userName.textContent = displayName;
        userAvatar.textContent = displayName.charAt(0).toUpperCase();
        
        // Load user's neural nodes
        await loadNeuralNodes();
        
        // Load recent activities
        await loadNeuralActivities();
        
        // Log dashboard access
        await neuralManager.logNeuralActivity(currentUser.id, 'Neural dashboard accessed');
        
        showNeuralNotification(`Neural control center initialized. Welcome back, ${displayName}!`, "success");
        
      } catch (error) {
        console.error('Dashboard initialization error:', error);
        showNeuralNotification("Access denied. Please authenticate first.", "error");
        setTimeout(() => {
          window.location.href = "login/index.html";
        }, 2000);
      }
    }

    // Load user's neural nodes from database
    async function loadNeuralNodes() {
      try {
        const { data: nodes, error } = await neuralManager.supabase
          .from('neural_nodes')
          .select('*')
          .eq('user_id', currentUser.id);

        if (error) throw error;

        userNodes = nodes;
        updateNodeStates();
        
      } catch (error) {
        console.error('Error loading neural nodes:', error);
        showNeuralNotification("Failed to load neural node configurations", "warning");
      }
    }

    // Update the visual state of nodes based on database
    function updateNodeStates() {
      const nodeElements = document.querySelectorAll('.neural-node');
      
      nodeElements.forEach(nodeElement => {
        const nodeLabel = nodeElement.querySelector('.node-label').textContent.replace(/\s+/g, ' ').trim();
        const userNode = userNodes.find(node => node.node_name === nodeLabel);
        
        if (userNode && userNode.is_active) {
          nodeElement.classList.add('active');
          nodeElement.querySelector('.node-status').classList.add('online');
        } else {
          nodeElement.classList.remove('active');
          nodeElement.querySelector('.node-status').classList.remove('online');
        }
      });
    }

    // Load recent neural activities
    async function loadNeuralActivities() {
      try {
        const result = await neuralManager.getNeuralActivities(currentUser.id, 5);
        
        if (result.success && result.activities.length > 0) {
          const activityFeed = document.querySelector('.activity-feed');
          const existingItems = activityFeed.querySelectorAll('.activity-item');
          
          // Remove existing items except the title
          existingItems.forEach(item => item.remove());
          
          // Add new activities
          result.activities.forEach(activity => {
            const activityItem = document.createElement('div');
            activityItem.className = 'activity-item';
            
            const timeAgo = getTimeAgo(new Date(activity.timestamp));
            
            activityItem.innerHTML = `
              <div class="activity-dot"></div>
              <div class="activity-text">${activity.activity}</div>
              <div class="activity-time">${timeAgo}</div>
            `;
            
            activityFeed.appendChild(activityItem);
          });
        }
        
      } catch (error) {
        console.error('Error loading activities:', error);
      }
    }

    // Helper function to calculate time ago
    function getTimeAgo(date) {
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      
      if (diffMins < 1) return 'now';
      if (diffMins < 60) return `${diffMins}m ago`;
      if (diffMins < 1440) return `${Math.floor(diffMins / 60)}h ago`;
      return `${Math.floor(diffMins / 1440)}d ago`;
    }

    async function logout() {
      showNeuralNotification("Disconnecting from neural network...", "info");
      
      try {
        // Log logout activity
        if (currentUser) {
          await neuralManager.logNeuralActivity(currentUser.id, 'Neural session terminated');
        }
        
        // Disconnect from Supabase
        await neuralManager.disconnectNeural();
        
        // Clear session data
        sessionStorage.removeItem('neuralSession');
        
        setTimeout(() => {
          window.location.href = "login/index.html";
        }, 1500);
        
      } catch (error) {
        console.error('Logout error:', error);
        // Force logout even if there's an error
        sessionStorage.removeItem('neuralSession');
        window.location.href = "login/index.html";
      }
    }

    // Make logout function global
    window.logout = logout;

    // Initialize dashboard when page loads
    document.addEventListener('DOMContentLoaded', initializeDashboard);

    async function toggleNode(element, nodeName) {
      const status = element.querySelector('.node-status');
      const isActive = element.classList.contains('active');
      
      try {
        // Update in database
        const { error } = await neuralManager.supabase
          .from('neural_nodes')
          .update({ 
            is_active: !isActive,
            updated_at: new Date().toISOString()
          })
          .eq('user_id', currentUser.id)
          .eq('node_name', nodeName);

        if (error) throw error;

        // Update UI
        if (isActive) {
          element.classList.remove('active');
          status.classList.remove('online');
          showNeuralNotification(`${nodeName} deactivated`, "warning");
        } else {
          element.classList.add('active');
          status.classList.add('online');
          showNeuralNotification(`${nodeName} activated`, "success");
        }

        // Log activity
        await neuralManager.logNeuralActivity(
          currentUser.id, 
          `${nodeName} ${isActive ? 'deactivated' : 'activated'}`,
          'node_toggle'
        );

        // Update local nodes array
        const nodeIndex = userNodes.findIndex(node => node.node_name === nodeName);
        if (nodeIndex !== -1) {
          userNodes[nodeIndex].is_active = !isActive;
        }
        
      } catch (error) {
        console.error('Error toggling node:', error);
        showNeuralNotification(`Failed to toggle ${nodeName}. Connection error.`, "error");
        return;
      }
      
      // Add interaction effect
      element.style.transform = 'scale(0.95)';
      setTimeout(() => {
        element.style.transform = '';
      }, 150);
    }

    // Make toggleNode function global
    window.toggleNode = toggleNode;

    function showNeuralNotification(message, type = 'info') {
      // Remove existing notifications
      const existingNotification = document.querySelector('.neural-notification');
      if (existingNotification) {
        existingNotification.remove();
      }
      
      const notification = document.createElement('div');
      notification.className = 'neural-notification';
      
      const colors = {
        info: 'var(--primary-glow)',
        success: '#10b981',
        warning: 'var(--accent-glow)',
        error: '#ef4444'
      };
      
      notification.style.cssText = `
        position: fixed;
        top: 30px;
        right: 30px;
        background: rgba(26, 26, 46, 0.95);
        border: 1px solid ${colors[type]};
        border-radius: 12px;
        padding: 16px 20px;
        color: var(--text-primary);
        font-family: 'Inter', sans-serif;
        font-size: 14px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3), 0 0 20px ${colors[type]}33;
        backdrop-filter: blur(20px);
        z-index: 1000;
        animation: slideInRight 0.3s ease-out;
        max-width: 350px;
      `;
      
      notification.innerHTML = `
        <div style="display: flex; align-items: center; gap: 12px;">
          <div style="width: 8px; height: 8px; background: ${colors[type]}; border-radius: 50%; box-shadow: 0 0 10px ${colors[type]};"></div>
          <span>${message}</span>
        </div>
      `;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.animation = 'slideOutRight 0.3s ease-in forwards';
        setTimeout(() => notification.remove(), 300);
      }, 4000);
    }

    // Add CSS animations
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideInRight {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
      
      @keyframes slideOutRight {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(100%);
          opacity: 0;
        }
      }
    `;
    document.head.appendChild(style);

    // Initialize dynamic activity updates
    setInterval(() => {
      const activities = [
        "Neural pathways optimized",
        "Memory consolidation complete",
        "Learning algorithms updated",
        "Security scan completed",
        "Data synchronization active",
        "Performance metrics updated"
      ];
      
      const activityFeed = document.querySelector('.activity-feed');
      const items = activityFeed.querySelectorAll('.activity-item');
      
      if (Math.random() > 0.7) { // 30% chance every 10 seconds
        const newActivity = document.createElement('div');
        newActivity.className = 'activity-item';
        newActivity.innerHTML = `
          <div class="activity-dot"></div>
          <div class="activity-text">${activities[Math.floor(Math.random() * activities.length)]}</div>
          <div class="activity-time">now</div>
        `;
        
        activityFeed.insertBefore(newActivity, items[0]);
        
        if (items.length >= 5) {
          items[items.length - 1].remove();
        }
      }
    }, 10000);
  </script>
</body>
</html>
